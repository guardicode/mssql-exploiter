from pathlib import PureWindowsPath
from unittest.mock import MagicMock

import pytest
from mssql_exploiter.mssql_command_builder import (
    build_mssql_agent_download_command,
    build_mssql_agent_launch_command,
)

from infection_monkey.exploit import IAgentOTPProvider
from infection_monkey.model import DROPPER_ARG
from infection_monkey.utils.ids import get_agent_id

AGENT_EXE_PATH = PureWindowsPath("C:\\agent.exe")
OTP = "123456"
AGENT_ID = get_agent_id()


@pytest.fixture
def otp_provider() -> IAgentOTPProvider:
    provider = MagicMock(spec=IAgentOTPProvider)
    provider.get_otp.return_value = OTP
    return provider


def test_launch_command__servers(
    otp_provider: IAgentOTPProvider,
):
    servers = ["127.0.0.1", "192.168.1.100", "172.1.2.3"]
    command = build_mssql_agent_launch_command(
        AGENT_ID,
        servers,
        2,
        AGENT_EXE_PATH,
        otp_provider,
    )

    for s in servers:
        assert s in command


def test_launch_command__monkey_used(otp_provider: IAgentOTPProvider):
    command = build_mssql_agent_launch_command(
        AGENT_ID,
        ["127.0.0.1"],
        2,
        AGENT_EXE_PATH,
        otp_provider,
    )

    assert DROPPER_ARG in command


def test_launch_command__otp_used(otp_provider: IAgentOTPProvider):
    command = build_mssql_agent_launch_command(
        AGENT_ID,
        ["127.0.0.1"],
        2,
        AGENT_EXE_PATH,
        otp_provider,
    )

    assert OTP in command


def test_launch_command__xp_cmdshell(otp_provider: IAgentOTPProvider):
    command = build_mssql_agent_launch_command(
        AGENT_ID,
        ["127.0.0.1"],
        2,
        AGENT_EXE_PATH,
        otp_provider,
    )

    assert command.startswith("xp_cmdshell")


def test_download_command__xp_cmdshell(otp_provider: IAgentOTPProvider):
    command = build_mssql_agent_download_command(
        "http://some_link.com",
        AGENT_EXE_PATH,
    )

    assert command.startswith("xp_cmdshell")
    assert str(AGENT_EXE_PATH) in command
