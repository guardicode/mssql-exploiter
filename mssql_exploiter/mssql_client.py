import logging
from ipaddress import IPv4Address
from time import sleep
from typing import Optional, Set

import pymssql

from common.credentials import Credentials
from common.types import NetworkPort

logger = logging.getLogger(__name__)
QUERY_BUFFER_TIME = 0.5
CONNECTION_CHECK_QUERY = "SELECT 1"


class MSSQLClient:
    def __init__(self, server_timeout: float, query_buffer_time: float = QUERY_BUFFER_TIME):
        self._cursor: Optional[pymssql.Cursor] = None
        self._server_timeout = server_timeout
        self._query_buffer_time = query_buffer_time

    def login(self, ip: IPv4Address, ports: Set[NetworkPort], credentials: Credentials):
        for port in ports:
            connection = pymssql.connect(
                str(ip),
                credentials.identity.username,
                credentials.secret.password.get_secret_value(),
                port=port,
                login_timeout=self._server_timeout,
                timeout=self._server_timeout,
            )
            try:
                self._cursor = connection.cursor()
                self._cursor.execute(CONNECTION_CHECK_QUERY)
                self._cursor.fetchall()
                break
            except pymssql.OperationalError:
                logger.debug("MSSQL connection is not active")

    def run_command(self, command: str):
        if self._cursor is None:
            raise RuntimeError("You are not logged in. Please log in before running commands.")
        self._cursor.execute(command)
        sleep(self._query_buffer_time)
