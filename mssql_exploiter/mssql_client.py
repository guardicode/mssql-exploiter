from ipaddress import IPv4Address
from time import sleep
from typing import Optional

import pymssql

from common.credentials import Credentials
from common.types import NetworkPort


class MSSQLClient:
    def __init__(self, login_timeout: float, query_timeout: float, query_buffer: float):
        self._cursor: Optional[pymssql.Cursor] = None
        self._login_timeout = login_timeout
        self._query_timeout = query_timeout
        self._query_buffer = query_buffer

    def login(self, ip: IPv4Address, port: NetworkPort, credentials: Credentials):
        conn = pymssql.connect(
            str(ip),
            credentials.identity.username,
            credentials.secret.password,
            port=port,
            login_timeout=self._login_timeout,
            timeout=self._query_timeout,
        )
        self._cursor = conn.cursor()

    def run_command(self, command: str):
        if self._cursor is None:
            raise Exception("Must login first")
        self._cursor.execute(command)
        sleep(self._query_buffer)
