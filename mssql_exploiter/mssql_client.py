from ipaddress import IPv4Address
from time import sleep
from typing import Optional

import pymssql

from common.credentials import Credentials
from common.types import NetworkPort

QUERY_BUFFER_TIME = 0.5


class MSSQLClient:
    def __init__(self, server_timeout: float, query_buffer_time: float = QUERY_BUFFER_TIME):
        self._cursor: Optional[pymssql.Cursor] = None
        self._server_timeout = server_timeout
        self._query_buffer_time = query_buffer_time

    def login(self, ip: IPv4Address, port: NetworkPort, credentials: Credentials):
        conn = pymssql.connect(
            str(ip),
            credentials.identity.username,
            credentials.secret.password,
            port=port,
            login_timeout=self._server_timeout,
            timeout=self._server_timeout,
        )
        self._cursor = conn.cursor()

    def run_command(self, command: str):
        if self._cursor is None:
            raise Exception("Must login first")
        self._cursor.execute(command)
        sleep(self._query_buffer_time)
